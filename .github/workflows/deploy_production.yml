name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (default: production)'
        required: false
        default: 'production'
        type: string
env:
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Image Tag
        id: set_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=production" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            # 배포 디렉토리로 이동
            cd ~/kkambbaki/infra/production || {
              echo "Error: 배포 디렉토리를 찾을 수 없습니다."
              exit 1
            }

            # 배포 스크립트 실행 권한 확인
            if [ ! -x ./deploy.sh ]; then
              chmod +x ./deploy.sh
            fi

            # 이미지 태그 환경 변수 설정
            export DOCKER_IMAGE_TAG=${{ steps.set_tag.outputs.IMAGE_TAG }}

            # deploy.sh 실행
            ./deploy.sh

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "✅ Production 배포 성공!"
          echo "Image Tag: ${{ steps.set_tag.outputs.IMAGE_TAG }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "❌ Production 배포 실패!"
          echo "Image Tag: ${{ steps.set_tag.outputs.IMAGE_TAG }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
